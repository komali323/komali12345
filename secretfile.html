<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>secretfile</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p><strong>I tried to reproduce the issue in my environment and got the below output</strong></p>
<p>I have created the <em><strong>RG &amp; AKS cluster</strong></em> using below commands</p>
<pre><code>az group create --name RG_Name --location eastus
az aks create -g RG_Name -n mycluster_name
</code></pre>
<p>I have created the <em><strong>key vault</strong></em> and <em><strong>secrets</strong></em> using below commands</p>
<pre><code>    az keyvault create --location eastus --name kv_name --resource-group RG_name
   az keyvault secret set --name MYsecret_name --value "password" --vault-name KV_name
</code></pre>
<p>we have to enable or add the <em><strong>CSI drivers</strong></em> using this command</p>
<pre><code>az aks enable-addons --addons azure-keyvault-secrets-provider --name Cluster_name --resource-group RG_Name
</code></pre>
<p><em><strong>we can also add the CSI drivers while creating AKS Cluster</strong></em><br>
<strong><em>Refrence for portal</em>:</strong></p>
<p><img src="https://i.imgur.com/dqhi9Uj.png" alt="enter image description here"></p>
<p><em><strong>Check the CSI diver is installed or not using below commands</strong></em></p>
<pre><code>kubectl get pods -n kube-system -l 'app in (secrets-store-csi-driver, secrets-store-provider-azure)'
</code></pre>
<p><img src="https://i.imgur.com/MBE97xc.png" alt="enter image description here"></p>
<p><em>Verify that your virtual machine scale set or availability set nodes have their own system-assigned identity, if not we have to enable it</em></p>
<p><img src="https://i.imgur.com/6moMlUy.png" alt="enter image description here"></p>
<p><em><strong>I have given the identity permissions in  that enable it to read the key vault and its content</strong></em></p>
<p><em>GOTO&gt;key vault&gt;Access_policiies</em>&gt; in</p>
<ul>
<li><em>permissions&gt;click on secret permissions</em></li>
<li><em>principal&gt;select your account</em></li>
<li><em>application&gt;select the application&gt;create</em></li>
</ul>
<p><em><strong>Created the secretprovider class by using this provider class by this class will get the secrets from the key vault</strong></em></p>
<pre class=" language-yaml"><code class="prism  language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  
<span class="token key atrule">kind</span><span class="token punctuation">:</span> SecretProviderClass  
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  
<span class="token key atrule">name</span><span class="token punctuation">:</span> azure<span class="token punctuation">-</span>kvname<span class="token punctuation">-</span>system<span class="token punctuation">-</span>msi  
<span class="token key atrule">spec</span><span class="token punctuation">:</span>  
<span class="token key atrule">provider</span><span class="token punctuation">:</span> azure  
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>  
<span class="token key atrule">usePodIdentity</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  
<span class="token key atrule">useVMManagedIdentity</span><span class="token punctuation">:</span> <span class="token string">"true"</span> 
<span class="token key atrule">userAssignedIdentityID</span><span class="token punctuation">:</span> <span class="token string">""</span> 
<span class="token key atrule">keyvaultName</span><span class="token punctuation">:</span> aksdemocluster<span class="token punctuation">-</span>kv  
<span class="token key atrule">cloudName</span><span class="token punctuation">:</span> <span class="token string">"AzurePublicCloud"</span> 
<span class="token key atrule">objects</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>  
<span class="token key atrule">array</span><span class="token punctuation">:</span>  
<span class="token punctuation">-</span> <span class="token punctuation">|</span>  
<span class="token key atrule">objectName</span><span class="token punctuation">:</span> komali<span class="token punctuation">-</span>password  
<span class="token key atrule">objectType</span><span class="token punctuation">:</span> secret  
<span class="token key atrule">objectVersion</span><span class="token punctuation">:</span> <span class="token string">""</span>
<span class="token key atrule">tenantId</span><span class="token punctuation">:</span> XXXXXXXX

</code></pre>
<p><em>Apply the below command to deploy the cluster</em></p>
<pre><code>kubectl apply -f class_file_name.yaml
</code></pre>
<p><em>By deploying the provider class the secrets will not be created for that we have to create the POD which will mount the volume by utilizing the CSI drivers</em></p>
<pre class=" language-yaml"><code class="prism  language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod  
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  
<span class="token key atrule">name</span><span class="token punctuation">:</span> busybox<span class="token punctuation">-</span>secrets  
<span class="token key atrule">spec</span><span class="token punctuation">:</span>  
<span class="token key atrule">containers</span><span class="token punctuation">:</span>  
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox  
<span class="token key atrule">image</span><span class="token punctuation">:</span> busybox  
<span class="token key atrule">command</span><span class="token punctuation">:</span>  
<span class="token punctuation">-</span> <span class="token string">"/bin/sleep"</span>  
<span class="token punctuation">-</span> <span class="token string">"1000"</span>  
<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> XXXX  
<span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/mnt/secrets-store"</span>  
<span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span>
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>  
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> XXXXX 
<span class="token key atrule">csi</span><span class="token punctuation">:</span>  
<span class="token key atrule">driver</span><span class="token punctuation">:</span> driver_name  
<span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span>
<span class="token key atrule">volumeAttributes</span><span class="token punctuation">:</span>  
<span class="token key atrule">secretProviderClass</span><span class="token punctuation">:</span> <span class="token string">"class_name"</span>
</code></pre>
<p><em>Apply the below command to deploy the pod</em></p>
<pre><code>kubectl apply -f pod.yaml
</code></pre>
<p>Check the pod if it is created or not using <code>kubectl get pods</code></p>
<p><img src="https://i.imgur.com/5I3NTt2.png" alt="enter image description here"></p>
<p><em>After the pod starts, the mounted content at the volume path that we specified in YAML is available</em></p>
<pre><code>kubectl exec busybox-secrets-store-inline-system-msi -- ls /mnt/secrets-store/       
kubectl exec busybox-secrets-store-inline-system-msi -- cat /mnt/secrets-store/"secret_name"
</code></pre>
</div>
</body>

</html>
